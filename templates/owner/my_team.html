{% extends 'base.html' %}

{% block title %}My Team - {{ team.name }} - SEPL{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Team Header -->
    <div class="card mb-4 bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="card-body text-white">
            <div class="row align-items-center">
                <div class="col-md-2 text-center">
                    {% if team.logo %}
                    <img src="{{ team.logo.url }}" alt="{{ team.name }}" class="img-fluid rounded-circle" style="max-width: 150px; border: 4px solid white;">
                    {% else %}
                    <div class="bg-white rounded-circle d-flex align-items-center justify-content-center" style="width: 150px; height: 150px; margin: 0 auto;">
                        <i class="bi bi-shield-fill text-primary" style="font-size: 5rem;"></i>
                    </div>
                    {% endif %}
                </div>
                <div class="col-md-7">
                    <h1 class="display-4 mb-2">{{ team.name }}</h1>
                    <p class="mb-1"><i class="bi bi-person-badge"></i> <strong>Owner:</strong> {{ team.owner.get_full_name }}</p>
                    {% if team.manager %}
                    <p class="mb-0"><i class="bi bi-clipboard-data"></i> <strong>Manager:</strong> {{ team.manager.get_full_name }}</p>
                    {% endif %}
                </div>
                <div class="col-md-3 text-center">
                    <h6 class="text-uppercase mb-2">Purse Status</h6>
                    <h2 class="mb-0">₹{{ team.purse_remaining }}</h2>
                    <div class="progress mt-2" style="height: 10px;">
                        <div class="progress-bar bg-warning" role="progressbar" style="width: {{ purse_percentage }}%"></div>
                    </div>
                    <small>{{ purse_percentage|floatformat:1 }}% remaining</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Squad Overview -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-people-fill"></i> Total Squad</h6>
                    <h3 class="mb-0">{{ regular_count }} + {{ iconic_count }}</h3>
                    <small>Regular + Iconic Players</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-star-fill"></i> Iconic Players</h6>
                    <h3 class="mb-0">{{ iconic_count }}/2</h3>
                    <small>Faculty members (Free)</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-cash-stack"></i> Total Spent</h6>
                    <h3 class="mb-0">₹{{ total_spent }}</h3>
                    <small>of ₹{{ team.total_purse }}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-clipboard-check"></i> Slots Remaining</h6>
                    <h3 class="mb-0">{{ effective_max_players|add:"-"|add:regular_count }}</h3>
                    <small>out of {{ effective_max_players }} regular slots</small>
                </div>
            </div>
        </div>
    </div>

    <!-- ICONIC PLAYERS SECTION (NEW) -->
    {% if iconic_players %}
    <div class="card mb-4 border-warning">
        <div class="card-header bg-warning text-dark">
            <h4 class="mb-0">
                <i class="bi bi-star-fill"></i> Iconic Players (Faculty Members)
                <span class="badge bg-dark float-end">{{ iconic_count }} Players</span>
            </h4>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> <strong>Iconic Players:</strong> Faculty members assigned to your team for free. They don't count against your purse but reduce your regular squad size.
            </div>
            <div class="row">
                {% for player in iconic_players %}
                <div class="col-md-6 mb-3">
                    <div class="card h-100 border-warning">
                        <div class="card-body">
                            <div class="d-flex align-items-start">
                                {% if player.user.profile_picture %}
                                <img src="{{ player.user.profile_picture.url }}" alt="{{ player.user.get_full_name }}" class="rounded-circle me-3" style="width: 80px; height: 80px; object-fit: cover;">
                                {% else %}
                                <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 80px; height: 80px;">
                                    <i class="bi bi-person-fill text-white" style="font-size: 2rem;"></i>
                                </div>
                                {% endif %}
                                <div class="flex-grow-1">
                                    <h5 class="mb-1">
                                        {{ player.user.get_full_name }}
                                        <span class="badge bg-warning text-dark">ICONIC</span>
                                    </h5>
                                    <p class="mb-1"><strong>Category:</strong> {{ player.get_category_display }}</p>
                                    <p class="mb-1"><strong>Branch:</strong> {{ player.user.get_branch_display|default:"N/A" }}</p>
                                    {% if player.batting_style %}
                                    <p class="mb-1"><small><i class="bi bi-lightning-fill"></i> {{ player.batting_style }}</small></p>
                                    {% endif %}
                                    {% if player.bowling_style %}
                                    <p class="mb-0"><small><i class="bi bi-arrow-repeat"></i> {{ player.bowling_style }}</small></p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Regular Squad Composition -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
                <i class="bi bi-diagram-3"></i> Regular Squad Composition
                <span class="badge bg-light text-dark float-end">{{ regular_count }} Players</span>
            </h4>
        </div>
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-3 text-center">
                    <div class="card bg-light">
                        <div class="card-body">
                            <i class="bi bi-bat" style="font-size: 2rem;"></i>
                            <h4 class="mt-2">{{ squad_stats.batsman.count }}</h4>
                            <p class="mb-0">Batsmen</p>
                            <small class="text-muted">₹{{ squad_stats.batsman.spent }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="card bg-light">
                        <div class="card-body">
                            <i class="bi bi-arrow-repeat" style="font-size: 2rem;"></i>
                            <h4 class="mt-2">{{ squad_stats.bowler.count }}</h4>
                            <p class="mb-0">Bowlers</p>
                            <small class="text-muted">₹{{ squad_stats.bowler.spent }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="card bg-light">
                        <div class="card-body">
                            <i class="bi bi-stars" style="font-size: 2rem;"></i>
                            <h4 class="mt-2">{{ squad_stats.all_rounder.count }}</h4>
                            <p class="mb-0">All-Rounders</p>
                            <small class="text-muted">₹{{ squad_stats.all_rounder.spent }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="card bg-light">
                        <div class="card-body">
                            <i class="bi bi-hand-thumbs-up" style="font-size: 2rem;"></i>
                            <h4 class="mt-2">{{ squad_stats.wicket_keeper.count }}</h4>
                            <p class="mb-0">Wicket-Keepers</p>
                            <small class="text-muted">₹{{ squad_stats.wicket_keeper.spent }}</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Players List by Category -->
            {% for category, data in squad_stats.items %}
            {% if data.players %}
            <h5 class="mt-4 mb-3 text-primary">
                {% if category == 'batsman' %}<i class="bi bi-bat"></i> Batsmen
                {% elif category == 'bowler' %}<i class="bi bi-arrow-repeat"></i> Bowlers
                {% elif category == 'all_rounder' %}<i class="bi bi-stars"></i> All-Rounders
                {% elif category == 'wicket_keeper' %}<i class="bi bi-hand-thumbs-up"></i> Wicket-Keepers
                {% endif %}
            </h5>
            <div class="row">
                {% for player in data.players %}
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-start">
                                {% if player.user.profile_picture %}
                                <img src="{{ player.user.profile_picture.url }}" alt="{{ player.user.get_full_name }}" class="rounded-circle me-3" style="width: 60px; height: 60px; object-fit: cover;">
                                {% else %}
                                <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
                                    <i class="bi bi-person-fill text-white" style="font-size: 1.5rem;"></i>
                                </div>
                                {% endif %}
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ player.user.get_full_name }}</h6>
                                    <p class="mb-1">
                                        <span class="badge bg-success">₹{{ player.current_bid }}</span>
                                        {% if player.user.player_type == 'student' %}
                                        <span class="badge bg-info">Student</span>
                                        {% endif %}
                                    </p>
                                    {% if player.batting_style or player.bowling_style %}
                                    <p class="mb-0 small text-muted">
                                        {% if player.batting_style %}{{ player.batting_style }}{% endif %}
                                        {% if player.batting_style and player.bowling_style %} | {% endif %}
                                        {% if player.bowling_style %}{{ player.bowling_style }}{% endif %}
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Bids</h5>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% if recent_bids %}
                    <div class="list-group">
                        {% for bid in recent_bids %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <strong>{{ bid.player.user.get_full_name }}</strong>
                                <span class="badge bg-primary">₹{{ bid.amount }}</span>
                            </div>
                            <small class="text-muted">{{ bid.timestamp|date:"M d, Y H:i" }}</small>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted">No bidding activity yet</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-trophy"></i> Auction Wins</h5>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% if auction_wins %}
                    <div class="list-group">
                        {% for log in auction_wins %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ log.player.user.get_full_name }}</strong>
                                    {% if log.player.user.player_type == 'faculty' %}
                                    <span class="badge bg-warning text-dark">ICONIC</span>
                                    {% endif %}
                                    <br>
                                    <small class="text-muted">{{ log.player.get_category_display }}</small>
                                </div>
                                <span class="badge bg-success">
                                    {% if log.player.user.player_type == 'faculty' %}FREE{% else %}₹{{ log.final_amount }}{% endif %}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted">No players won yet</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-gradient {
        position: relative;
        overflow: hidden;
    }
    .bg-gradient::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="rgba(255,255,255,0.1)" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,112C672,96,768,96,864,112C960,128,1056,160,1152,160C1248,160,1344,128,1392,112L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') no-repeat bottom;
        opacity: 0.3;
    }
</style>
{% endblock %}