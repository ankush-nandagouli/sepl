{% extends 'base.html' %}

{% block title %}Manage Iconic Players - SEPL Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-star-fill text-warning"></i> Manage Iconic Players</h2>
            <p class="text-muted">Assign up to 2 faculty members as iconic players per team (free, reduce squad size)</p>
        </div>
        <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h6 class="card-title">Total Iconic Players</h6>
                    <h3 class="mb-0">{{ total_iconic_players }}</h3>
                    <small>Faculty players available</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h6 class="card-title">Assigned Iconic Players</h6>
                    <h3 class="mb-0">
                        {% with assigned=iconic_players|filter:status='sold'|length %}
                        {{ assigned }}
                        {% endwith %}
                    </h3>
                    <small>Currently assigned to teams</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h6 class="card-title">Available Iconic Players</h6>
                    <h3 class="mb-0">
                        {% with available=iconic_players|filter:status='approved'|length %}
                        {{ available }}
                        {% endwith %}
                    </h3>
                    <small>Ready to be assigned</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Teams and Their Iconic Players -->
    <div class="row">
        {% for data in team_data %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 {% if data.iconic_count >= 2 %}border-success{% endif %}">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-shield-fill"></i> {{ data.team.name }}
                    </h5>
                    <span class="badge bg-light text-dark">
                        {{ data.iconic_count }}/2 Iconic
                    </span>
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <strong>Owner:</strong> {{ data.team.owner.get_full_name }}<br>
                        <strong>Squad:</strong> {{ data.team.players.count }}/{{ data.team.max_players }}
                    </p>

                    <hr>

                    <!-- Current Iconic Players -->
                    <h6 class="text-warning"><i class="bi bi-star-fill"></i> Iconic Players:</h6>
                    {% if data.iconic_players %}
                    <ul class="list-group mb-3">
                        {% for player in data.iconic_players %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ player.user.get_full_name }}</strong><br>
                                <small class="text-muted">{{ player.get_category_display }}</small>
                            </div>
                            <button class="btn btn-sm btn-danger remove-iconic-btn" 
                                    data-player-id="{{ player.id }}"
                                    data-player-name="{{ player.user.get_full_name }}"
                                    data-team-id="{{ data.team.id }}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted fst-italic">No iconic players assigned yet</p>
                    {% endif %}

                    <!-- Add Iconic Player -->
                    {% if data.can_add_more %}
                    <div class="mt-3">
                        <label class="form-label">Add Iconic Player:</label>
                        <select class="form-select iconic-player-select" data-team-id="{{ data.team.id }}">
                            <option value="">-- Select Faculty Player --</option>
                            {% for player in iconic_players %}
                                {% if not player.team or player.team.id == data.team.id %}
                                <option value="{{ player.id }}" 
                                        {% if player.team %}disabled{% endif %}>
                                    {{ player.user.get_full_name }} - {{ player.get_category_display }}
                                    {% if player.team %}(Assigned){% endif %}
                                </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        <button class="btn btn-success btn-sm mt-2 w-100 assign-iconic-btn" 
                                data-team-id="{{ data.team.id }}">
                            <i class="bi bi-plus-circle"></i> Assign as Iconic Player
                        </button>
                    </div>
                    {% else %}
                    <div class="alert alert-success mt-3">
                        <i class="bi bi-check-circle"></i> Maximum iconic players assigned
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-check-circle"></i> Success</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="successMessage"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        transition: transform 0.2s;
    }
    .card:hover {
        transform: translateY(-5px);
    }
    .list-group-item {
        transition: background-color 0.2s;
    }
    .list-group-item:hover {
        background-color: #f8f9fa;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const successModal = new bootstrap.Modal(document.getElementById('successModal'));

    // Assign Iconic Player
    document.querySelectorAll('.assign-iconic-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const teamId = this.getAttribute('data-team-id');
            const selectElement = document.querySelector(`.iconic-player-select[data-team-id="${teamId}"]`);
            const playerId = selectElement.value;

            if (!playerId) {
                alert('Please select a player first');
                return;
            }

            if (!confirm('Are you sure you want to assign this player as an iconic player?')) {
                return;
            }

            const formData = new FormData();
            formData.append('team_id', teamId);
            formData.append('player_id', playerId);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch('{% url "assign_iconic_player" %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('successMessage').textContent = data.message;
                    successModal.show();
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Network error: ' + error);
            });
        });
    });

    // Remove Iconic Player
    document.querySelectorAll('.remove-iconic-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const playerId = this.getAttribute('data-player-id');
            const playerName = this.getAttribute('data-player-name');

            if (!confirm(`Remove ${playerName} from iconic player status?`)) {
                return;
            }

            const formData = new FormData();
            formData.append('player_id', playerId);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch('{% url "remove_iconic_player" %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('successMessage').textContent = data.message;
                    successModal.show();
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Network error: ' + error);
            });
        });
    });
});
</script>
{% endblock %}